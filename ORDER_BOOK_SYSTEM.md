# μ£Όμ‹ μ‹μ¥ μ‹μ¤ν… κ°μ„  - νΈκ°€μ°½ λ° μ‹¤μ‹κ°„ μ²΄κ²° μ‹μ¤ν…

## π“ κ°μ”

μ‹¤μ  μ£Όμ‹ μ‹μ¥κ³Ό λ™μΌν• λ…Όλ¦¬λ΅ μ‘λ™ν•λ” νΈκ°€μ°½(Order Book) λ° μ‹μ¥ κΉμ΄(Market Depth) μ‹μ¤ν…μ„ κµ¬ν„ν–μµλ‹λ‹¤.

## π― μ£Όμ” κΈ°λ¥

### 1. νΈκ°€μ°½ μ‹μ¤ν… (Order Book)

#### λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§
```typescript
// order_book ν…μ΄λΈ”
- guildId: μ„λ²„ ID
- symbol: μΆ…λ© μ‹¬λ³Ό
- side: 'buy' | 'sell' (λ§¤μ/λ§¤λ„)
- price: κ°€κ²© (decimal)
- quantity: μλ‰
- unique constraint: (guildId, symbol, side, price)
```

#### νΉμ§•
- **μ‹¤μ‹κ°„ νΈκ°€ κ΄€λ¦¬**: κ° κ°€κ²©λ€λ³„ λ§¤μ/λ§¤λ„ μλ‰ μ¶”μ 
- **μλ™ μ²΄κ²°**: μ£Όλ¬Έ κ°€κ²©μ΄ λ°λ€νΈ μµμ°μ„  νΈκ°€μ™€ μΌμΉν•λ©΄ μ¦‰μ‹ μ²΄κ²°
- **λ¶€λ¶„ μ²΄κ²°**: μ£Όλ¬Έ μλ‰μ΄ νΈκ°€ μλ‰λ³΄λ‹¤ λ§μΌλ©΄ μ—¬λ¬ κ°€κ²©λ€μ— κ±Έμ³ μ²΄κ²°
- **μ¬λ¦¬ν”Όμ§€ κ³„μ‚°**: μ‹¤μ  ν‰κ·  μ²΄κ²°κ°€μ™€ μ£Όλ¬Έκ°€μ μ°¨μ΄λ¥Ό κ³„μ‚°

### 2. μ‹μ¥ κΉμ΄ (Market Depth)

#### λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§
```typescript
// market_depth ν…μ΄λΈ”
- guildId: μ„λ²„ ID
- symbol: μΆ…λ© μ‹¬λ³Ό
- bidPrices: JSONB [{price, quantity}, ...] // λ§¤μ νΈκ°€ λ°°μ—΄
- askPrices: JSONB [{price, quantity}, ...] // λ§¤λ„ νΈκ°€ λ°°μ—΄
- spread: λ§¤μ/λ§¤λ„ μ¤ν”„λ λ“
- lastUpdated: λ§μ§€λ§‰ μ—…λ°μ΄νΈ μ‹κ°„
```

#### νΉμ§•
- **μ§‘κ³„ λ°μ΄ν„°**: νΈκ°€μ°½ λ°μ΄ν„°λ¥Ό μ§‘κ³„ν•μ—¬ μ‹μ¥ κΉμ΄ μ‹κ°ν™”
- **μ¤ν”„λ λ“ μ¶”μ **: μµμ°μ„  λ§¤μνΈκ°€μ™€ λ§¤λ„νΈκ°€μ μ°¨μ΄ κ³„μ‚°
- **μ„±λ¥ μµμ ν™”**: JSONB νƒ€μ…μΌλ΅ λΉ λ¥Έ μ΅°ν

### 3. μ£Όλ¬Έ λ§¤μΉ­ μ—”μ§„ (Order Matching)

#### μ‘λ™ λ°©μ‹

**λ§¤μ μ£Όλ¬Έ μ²λ¦¬**:
1. νΈκ°€μ°½μ—μ„ κ°€μ¥ λ‚®μ€ λ§¤λ„ νΈκ°€λ¶€ν„° κ²€μƒ‰
2. μ£Όλ¬Έ κ°€κ²©λ³΄λ‹¤ λ‚®κ±°λ‚ κ°™μ€ λ§¤λ„ νΈκ°€μ™€ μ²΄κ²°
3. μλ‰μ΄ λ¶€μ΅±ν•λ©΄ λ‹¤μ κ°€κ²©λ€λ΅ μ΄λ™ (λ¶€λ¶„ μ²΄κ²°)
4. μ²΄κ²° ν›„ λ‚¨μ€ μλ‰μ€ νΈκ°€μ°½μ— λ§¤μ μ£Όλ¬ΈμΌλ΅ λ“±λ΅

**λ§¤λ„ μ£Όλ¬Έ μ²λ¦¬**:
1. νΈκ°€μ°½μ—μ„ κ°€μ¥ λ†’μ€ λ§¤μ νΈκ°€λ¶€ν„° κ²€μƒ‰
2. μ£Όλ¬Έ κ°€κ²©λ³΄λ‹¤ λ†’κ±°λ‚ κ°™μ€ λ§¤μ νΈκ°€μ™€ μ²΄κ²°
3. μλ‰μ΄ λ¶€μ΅±ν•λ©΄ λ‹¤μ κ°€κ²©λ€λ΅ μ΄λ™ (λ¶€λ¶„ μ²΄κ²°)
4. μ²΄κ²° ν›„ λ‚¨μ€ μλ‰μ€ νΈκ°€μ°½μ— λ§¤λ„ μ£Όλ¬ΈμΌλ΅ λ“±λ΅

#### μ½”λ“ μμ‹
```typescript
async executeOrderWithMatching(
  guildId: string,
  userId: string,
  symbol: string,
  side: 'buy' | 'sell',
  quantity: number,
  limitPrice: number
) {
  // νΈκ°€μ°½ μ΅°ν
  const orderBook = await this.storage.getOrderBook(guildId, symbol, 50);
  
  // μ²΄κ²° κ°€λ¥ν• μ£Όλ¬Έ μ°ΎκΈ°
  for (const matchOrder of availableOrders) {
    const matchQuantity = Math.min(remainingQuantity, matchOrder.quantity);
    
    // κ±°λ μ‹¤ν–‰
    await this.storage.executeTrade(...);
    
    // νΈκ°€μ°½ μ—…λ°μ΄νΈ
    await this.storage.updateOrderBook(...);
  }
  
  // ν‰κ·  μ²΄κ²°κ°€ λ° μ¬λ¦¬ν”Όμ§€ κ³„μ‚°
  return {
    averagePrice,
    totalQuantity,
    fills,
    slippage
  };
}
```

### 4. API μ—”λ“ν¬μΈνΈ

#### νΈκ°€μ°½ μ΅°ν
```
GET /api/web-client/guilds/:guildId/stocks/:symbol/orderbook?depth=10
```

**μ‘λ‹µ μμ‹**:
```json
{
  "bids": [
    {"price": 10100, "quantity": 50},
    {"price": 10050, "quantity": 100}
  ],
  "asks": [
    {"price": 10200, "quantity": 75},
    {"price": 10250, "quantity": 120}
  ],
  "bestBid": 10100,
  "bestAsk": 10200,
  "spread": 100,
  "timestamp": "2025-01-22T10:30:00Z"
}
```

#### μ‹μ¥ κΉμ΄ μ΅°ν
```
GET /api/web-client/guilds/:guildId/stocks/:symbol/depth
```

**μ‘λ‹µ μμ‹**:
```json
{
  "guildId": "1284053249057620018",
  "symbol": "AAPL",
  "bidPrices": [
    {"price": 10100, "quantity": 50},
    {"price": 10050, "quantity": 100}
  ],
  "askPrices": [
    {"price": 10200, "quantity": 75},
    {"price": 10250, "quantity": 120}
  ],
  "spread": "100.00",
  "lastUpdated": "2025-01-22T10:30:00Z"
}
```

### 5. ν”„λ΅ νΈμ—”λ“ μ»΄ν¬λ„νΈ

#### OrderBook μ»΄ν¬λ„νΈ
- **μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ**: WebSocketμΌλ΅ 2μ΄λ§λ‹¤ μλ™ κ°±μ‹ 
- **μ‹κ°ν™”**: κ°€κ²©λ€λ³„ μλ‰μ„ λ°” μ°¨νΈλ΅ ν‘μ‹
- **μƒ‰μƒ κµ¬λ¶„**: λ§¤μλ” μ΄λ΅μƒ‰, λ§¤λ„λ” λΉ¨κ°„μƒ‰
- **ν†µκ³„**: μ΄ λ§¤μ/λ§¤λ„ μλ‰, μ¤ν”„λ λ“ ν‘μ‹

#### MarketDepth μ»΄ν¬λ„νΈ
- **μ°¨νΈ μ‹κ°ν™”**: Rechartsλ΅ μ‹μ¥ κΉμ΄ μ‹κ°ν™”
- **μ–‘λ°©ν–¥ μ°¨νΈ**: λ§¤μλ” μ„λ΅, λ§¤λ„λ” μ•„λλ΅ ν‘μ‹
- **ν†µκ³„**: λ§¤μ/λ§¤λ„ λΉ„μ¨, μ΄ μλ‰ ν‘μ‹
- **μλ™ κ°±μ‹ **: 5μ΄λ§λ‹¤ μ—…λ°μ΄νΈ

### 6. μ‹¤μ‹κ°„ ν†µμ‹ 

#### WebSocket μ΄λ²¤νΈ
```typescript
// μ£Όλ¬Έ μ²΄κ²° μ‹
wsManager.broadcast('trade_executed', {
  averagePrice,
  totalQuantity,
  fills,
  slippage
});

// νΈκ°€μ°½ μ—…λ°μ΄νΈ μ‹
wsManager.broadcast('order_book_updated', {
  guildId,
  symbol,
  orderBook: { bids, asks }
});
```

## π”§ κµ¬ν„ νμΌ

### Backend
- `shared/schema.ts`: λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ μ •μ
- `server/storage.ts`: νΈκ°€μ°½/μ‹μ¥ κΉμ΄ μ €μ¥μ† λ©”μ„λ“
- `server/services/trading-engine.ts`: μ£Όλ¬Έ λ§¤μΉ­ μ—”μ§„
- `server/routes.ts`: API μ—”λ“ν¬μΈνΈ

### Frontend
- `client/src/components/OrderBook.tsx`: νΈκ°€μ°½ UI
- `client/src/components/MarketDepth.tsx`: μ‹μ¥ κΉμ΄ μ°¨νΈ
- `client/src/pages/dashboard.tsx`: λ€μ‹λ³΄λ“ ν†µν•©

## π“ μ‹¤μ  μ‹μ¥κ³Όμ λΉ„κµ

| κΈ°λ¥ | μ‹¤μ  μ‹μ¥ | μ΄ μ‹μ¤ν… | μƒνƒ |
|------|----------|----------|------|
| νΈκ°€μ°½ | β… | β… | μ™„λ£ |
| μ²΄κ²° μ‹μ¤ν… | β… | β… | μ™„λ£ |
| μ‹μ¥ κΉμ΄ | β… | β… | μ™„λ£ |
| μ¬λ¦¬ν”Όμ§€ | β… | β… | μ™„λ£ |
| κ±°λλ‰ κΈ°λ° κ°€κ²© μν–¥ | β… | β… | μ΄λ―Έ κµ¬ν„λ¨ |
| νΈκ°€ μ°μ„ μμ„ (κ°€κ²©-μ‹κ°„) | β… | β οΈ | κ°€κ²© μ°μ„ λ§ κµ¬ν„ |
| νΈκ°€ μ”λ‰ ν‘μ‹ | β… | β… | μ™„λ£ |
| μ²΄κ²° λ‚΄μ—­ | β… | β… | μ™„λ£ |

## π® μ‚¬μ© μμ‹

### Discord Botμ—μ„
```
/μ£Όμ‹λ§¤μ AAPL 10 10150
β†’ νΈκ°€μ°½μ„ ν™•μΈν•μ—¬ 10,100μ›μ— 5μ£Ό, 10,150μ›μ— 5μ£Ό μ²΄κ²°
β†’ ν‰κ·  μ²΄κ²°κ°€: 10,125μ›
β†’ μ¬λ¦¬ν”Όμ§€: 0.25%
```

### μ›Ή λ€μ‹λ³΄λ“μ—μ„
1. μΆ…λ© μ„ νƒ
2. νΈκ°€μ°½μ—μ„ λ§¤μ/λ§¤λ„ νΈκ°€ μ‹¤μ‹κ°„ ν™•μΈ
3. μ‹μ¥ κΉμ΄ μ°¨νΈλ΅ μ λ™μ„± νμ•…
4. μ£Όλ¬Έ μ‹¤ν–‰ μ‹ μλ™μΌλ΅ μµμ κ°€ μ²΄κ²°

## π€ ν–¥ν›„ κ°μ„  μ‚¬ν•­

1. **μ‹κ°„ μ°μ„  μ›μΉ™**: κ°™μ€ κ°€κ²©μ μ£Όλ¬Έμ€ λ¨Όμ € λ“¤μ–΄μ¨ μμ„λ€λ΅ μ²΄κ²°
2. **IOC/FOK μ£Όλ¬Έ**: Immediate-or-Cancel, Fill-or-Kill μ£Όλ¬Έ νƒ€μ…
3. **Stop Loss/Take Profit**: μ†μ λ§¤/μµμ  μλ™ μ£Όλ¬Έ
4. **νΈκ°€ ν†µκ³„**: νΈκ°€ λ³€λ™ μ¶”μ΄, μ²΄κ²°κ°•λ„ μ§€ν‘
5. **μ•κ³ λ¦¬μ¦ νΈλ μ΄λ”©**: μλ™λ§¤λ§¤ λ΄‡ μ§€μ›

## β… μ²΄ν¬λ¦¬μ¤νΈ

- [x] νΈκ°€μ°½ λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§
- [x] μ‹μ¥ κΉμ΄ μ¤λƒ…μƒ· ν…μ΄λΈ”
- [x] Storage λ μ΄μ–΄ λ©”μ„λ“
- [x] μ£Όλ¬Έ λ§¤μΉ­ μ—”μ§„
- [x] μ¬λ¦¬ν”Όμ§€ κ³„μ‚°
- [x] API μ—”λ“ν¬μΈνΈ
- [x] OrderBook μ»΄ν¬λ„νΈ
- [x] MarketDepth μ»΄ν¬λ„νΈ
- [x] λ€μ‹λ³΄λ“ ν†µν•©
- [x] WebSocket μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ

## π“ μ°Έκ³ 

μ΄ μ‹μ¤ν…μ€ μ‹¤μ  μ£Όμ‹ μ‹μ¥μ νΈκ°€μ°½ λ©”μ»¤λ‹μ¦μ„ λ‹¨μν™”ν•μ—¬ κµ¬ν„ν–μµλ‹λ‹¤. 
FIFO(First In First Out) μ›μΉ™μ„ μ™„λ²½ν•κ² κµ¬ν„ν•λ ¤λ©΄ κ° νΈκ°€μ— νƒ€μ„μ¤νƒ¬ν”„μ™€ μμ„λ¥Ό μ¶”κ°€ν•΄μ•Ό ν•μ§€λ§, 
ν„μ¬ λ²„μ „μ—μ„λ” κ°€κ²© μ°μ„  μ›μΉ™λ§ μ μ©ν•μ—¬ μ„±λ¥κ³Ό λ‹¨μμ„±μ κ· ν•μ„ λ§μ·„μµλ‹λ‹¤.
