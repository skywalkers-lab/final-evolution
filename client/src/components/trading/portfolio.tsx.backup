import { useQuery, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { useWebSocket } from "@/hooks/use-websocket";
import { useToast } from "@/hooks/use-toast";
import { useState, useEffect, useRef, useCallback } from "react";
import { apiRequest } from "@/lib/queryClient";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
impor                        {formatKoreanCurrency(Number(order.totalAmount))}
                      </div>
                      <div className="text-xs text-gray-400 mt-1">
                        {order.expiresAt ? `ë§Œë£Œ: ${format(new Date(order.expiresAt), 'MM-dd HH:mm', { locale: ko })}` : 'ë¬´ê¸°í•œ'}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )from "@/components/ui/badge";
import { formatKoreanCurrency } from "@/utils/formatCurrency";
import { convertToDirectImageUrl, handleImageError } from "@/utils/imageUrl";
import { format } from "date-fns";
import { ko } from "date-fns/locale";

interface PortfolioProps {
  guildId: string;
  userId: string;
}

export default function Portfolio({ guildId, userId }: PortfolioProps) {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [totalValue, setTotalValue] = useState(0);
  const [profitLoss, setProfitLoss] = useState(0);
  const [isTrading, setIsTrading] = useState<string | null>(null);

  const { data: portfolio, refetch } = useQuery({
    queryKey: [`/api/web-client/guilds/${guildId}/portfolio`],
    enabled: !!guildId,
  });

  const { data: accountData, refetch: refetchAccount } = useQuery({
    queryKey: [`/api/web-client/guilds/${guildId}/account`],
    enabled: !!guildId,
  });

  // ì§€ì •ê°€ ì£¼ë¬¸ ì¡°íšŒ
  const { data: limitOrders, isLoading: isLoadingOrders, error: ordersError } = useQuery({
    queryKey: [`/api/web-client/guilds/${guildId}/limit-orders`, 'pending'],
    queryFn: async () => {
      console.log('ğŸ” Fetching limit orders for guild:', guildId);
      const response = await apiRequest('GET', `/api/web-client/guilds/${guildId}/limit-orders?status=pending`);
      console.log('ğŸ“¦ Limit orders response:', response);
      return Array.isArray(response) ? response : [];
    },
    enabled: !!guildId,
    refetchInterval: 5000, // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
  });

  // ì§€ì •ê°€ ì£¼ë¬¸ ë°ì´í„° ë¡œê¹…
  useEffect(() => {
    console.log('ğŸ“Š Limit orders data:', limitOrders);
    console.log('â³ Loading orders:', isLoadingOrders);
    console.log('âŒ Orders error:', ordersError);
  }, [limitOrders, isLoadingOrders, ordersError]);

  // Debounced refetch to prevent race conditions
  const refetchTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  
  const debouncedRefetch = useCallback(() => {
    if (refetchTimeoutRef.current) {
      clearTimeout(refetchTimeoutRef.current);
    }
    
    refetchTimeoutRef.current = setTimeout(() => {
      refetch();
    }, 500); // 500ms delay to batch rapid updates
  }, [refetch]);

  // WebSocket handler for real-time portfolio updates
  useWebSocket((event: string, data: any) => {
    if (event === 'stock_price_updated' || event === 'trade_executed') {
      debouncedRefetch(); // Use debounced refetch for frequent events
    } else if (event === 'limit_order_executed') {
      // ì§€ì •ê°€ ì£¼ë¬¸ ì²´ê²° ì•Œë¦¼
      toast({
        title: "ğŸ¯ ì§€ì •ê°€ ì£¼ë¬¸ ì²´ê²°",
        description: `${data.symbol} ${data.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ${data.shares}ì£¼ê°€ â‚©${data.executionPrice.toLocaleString()}ì— ì²´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        variant: "default",
      });
      
      // í¬íŠ¸í´ë¦¬ì˜¤ì™€ ì§€ì •ê°€ ì£¼ë¬¸ ëª©ë¡ ê°±ì‹ 
      refetch();
      refetchAccount();
      queryClient.invalidateQueries({
        queryKey: [`/api/web-client/guilds/${guildId}/limit-orders`]
      });
    } else if (event === 'account_deleted') {
      // Refetch both portfolio and account data immediately for critical events
      refetch();
      refetchAccount();
      
      // Show notification about account deletion
      toast({
        title: "ê³„ì¢Œ ì‚­ì œë¨",
        description: `${data.username}ë‹˜ì˜ ê³„ì¢Œ(${data.accountCode})ê°€ ê´€ë¦¬ìì— ì˜í•´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,
        variant: "destructive",
      });
      
      console.log('ê³„ì¢Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤:', data);
    } else if (event === 'factory_reset') {
      // Refetch both portfolio and account data after factory reset
      refetch();
      refetchAccount();
      
      // Show notification about factory reset
      toast({
        title: "ê³µì¥ì´ˆê¸°í™” ì™„ë£Œ",
        description: "ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê³„ì¢Œë¥¼ ê°œì„¤í•˜ì„¸ìš”.",
        variant: "default",
      });
      
      console.log('ê³µì¥ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤:', data);
    }
  });

  useEffect(() => {
    if (portfolio) {
      setTotalValue((portfolio as any).totalValue || 0);
      // Calculate profit/loss based on holdings
      const holdings = (portfolio as any).holdings || [];
      let totalPL = 0;
      holdings.forEach((holding: any) => {
        const currentValue = holding.currentPrice * holding.shares;
        const originalValue = holding.avgPrice * holding.shares;
        totalPL += currentValue - originalValue;
      });
      setProfitLoss(totalPL);
    }
  }, [portfolio]);

  // Cleanup timeout on unmount
  useEffect(() => {
    return () => {
      if (refetchTimeoutRef.current) {
        clearTimeout(refetchTimeoutRef.current);
      }
    };
  }, []);

  const formatProfitLoss = (amount: number, percentage: number) => {
    const isPositive = amount >= 0;
    return (
      <div className="flex items-center space-x-1">
        <span className={isPositive ? 'text-red-500' : 'text-blue-500'}>
          {isPositive ? '+' : ''}{percentage.toFixed(1)}%
        </span>
        <span className={`text-xs ${isPositive ? 'text-red-500' : 'text-blue-500'}`}>
          ({isPositive ? '+' : ''}{formatKoreanCurrency(Math.abs(amount))})
        </span>
      </div>
    );
  };

  const executeTrade = async (symbol: string, type: 'buy' | 'sell', currentPrice: number) => {
    const tradeKey = `${symbol}-${type}`;
    if (isTrading === tradeKey) return; // ì´ë¯¸ ê±°ë˜ ì¤‘ì¸ ê²½ìš° ë¬´ì‹œ

    setIsTrading(tradeKey);
    try {
      const tradeData = {
        userId,
        symbol,
        type,
        shares: 1, // 1ì£¼ì”© ê±°ë˜
        price: currentPrice,
        orderType: 'market'
      };

      await apiRequest('POST', `/api/web-client/guilds/${guildId}/trades`, tradeData);

      // ì„±ê³µ í† ìŠ¤íŠ¸
      toast({
        title: type === 'buy' ? "ë§¤ìˆ˜ ì™„ë£Œ" : "ë§¤ë„ ì™„ë£Œ",
        description: `${symbol} 1ì£¼ë¥¼ ${formatKoreanCurrency(currentPrice)}ì— ${type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}í–ˆìŠµë‹ˆë‹¤.`,
        variant: "default",
      });

      // í¬íŠ¸í´ë¦¬ì˜¤ì™€ ê³„ì¢Œ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
      refetch();
      refetchAccount();
      
      // ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™”
      queryClient.invalidateQueries({
        queryKey: ['/api/web-client/guilds', guildId, 'portfolio']
      });
      queryClient.invalidateQueries({
        queryKey: ['/api/web-client/guilds', guildId, 'account']
      });

    } catch (error: any) {
      // ì—ëŸ¬ í† ìŠ¤íŠ¸
      toast({
        title: "ê±°ë˜ ì‹¤íŒ¨",
        description: error.message || `${type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`,
        variant: "destructive",
      });
    } finally {
      setIsTrading(null);
    }
  };

  const holdings = (portfolio as any)?.holdings || [];

  return (
    <div className="discord-bg-darker rounded-xl border border-discord-dark">
      <div className="p-6 border-b border-discord-dark">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <h3 className="text-lg font-semibold text-white">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>
            {(accountData as any)?.account ? (
              <div className="text-sm bg-discord-dark px-3 py-1 rounded-full" data-testid="text-account-number">
                <span className="text-gray-400">ê³„ì¢Œë²ˆí˜¸: </span>
                <span className="text-white font-mono">{(accountData as any).account.uniqueCode}</span>
              </div>
            ) : (
              <div className="text-sm bg-red-900/20 text-red-400 px-3 py-1 rounded-full border border-red-800" data-testid="text-no-account">
                ê³„ì¢Œì—†ìŒ
              </div>
            )}
          </div>
          <div className="flex items-center space-x-4">
            {(accountData as any)?.account ? (
              <>
                <div className="text-sm text-gray-400">
                  <span>ì´ í‰ê°€ì•¡: </span>
                  <span className="text-white font-medium" data-testid="text-portfolio-value">
                    {formatKoreanCurrency(totalValue)}
                  </span>
                </div>
                <div className="text-sm" data-testid="text-portfolio-change">
                  {formatProfitLoss(profitLoss, (profitLoss / Math.max(totalValue - profitLoss, 1)) * 100)}
                </div>
              </>
            ) : (
              <div className="text-sm text-gray-400" data-testid="text-no-portfolio">
                ê³„ì¢Œë¥¼ ê°œì„¤í•´ì£¼ì„¸ìš”
              </div>
            )}
          </div>
        </div>
      </div>
      
      <div className="p-6">
        {holdings.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left text-sm text-gray-400">
                  <th className="pb-3 font-medium">ì¢…ëª©ëª…</th>
                  <th className="pb-3 text-right font-medium">ë³´ìœ ëŸ‰</th>
                  <th className="pb-3 text-right font-medium">í‰ê· ë‹¨ê°€</th>
                  <th className="pb-3 text-right font-medium">í˜„ì¬ê°€</th>
                  <th className="pb-3 text-right font-medium">í‰ê°€ì•¡</th>
                  <th className="pb-3 text-center font-medium">ì†ìµë¥ </th>
                  <th className="pb-3 text-center font-medium">ì•¡ì…˜</th>
                </tr>
              </thead>
              <tbody className="text-sm">
                {holdings.map((holding: any, index: number) => {
                  const currentValue = holding.currentPrice * holding.shares;
                  const originalValue = holding.avgPrice * holding.shares;
                  const profitAmount = currentValue - originalValue;
                  const profitPercent = ((currentValue - originalValue) / originalValue) * 100;
                  
                  return (
                    <tr key={holding.symbol} className="border-t border-discord-dark" data-testid={`row-holding-${index}`}>
                      <td className="py-4">
                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 rounded-full overflow-hidden bg-discord-dark border border-discord-light flex items-center justify-center">
                            {holding.logoUrl ? (
                              <img 
                                src={holding.logoUrl} 
                                alt={`${holding.symbol} ë¡œê³ `}
                                className="w-full h-full object-cover"
                                onError={(e) => {
                                  // ë¡œê³  ë¡œë“œ ì‹¤íŒ¨ ì‹œ fallback
                                  const target = e.target as HTMLImageElement;
                                  target.style.display = 'none';
                                  const nextElement = target.nextElementSibling as HTMLElement;
                                  if (nextElement) nextElement.style.display = 'flex';
                                }}
                              />
                            ) : null}
                            <div className={`w-full h-full bg-discord-blue rounded-full flex items-center justify-center text-xs font-bold text-white ${holding.logoUrl ? 'hidden' : ''}`}>
                              {holding.symbol.substring(0, 2)}
                            </div>
                          </div>
                          <div>
                            <p className="text-white font-medium" data-testid={`text-holding-symbol-${index}`}>
                              {holding.symbol}
                            </p>
                            <p className="text-gray-400 text-xs" data-testid={`text-holding-name-${index}`}>
                              {holding.name || holding.symbol}
                            </p>
                          </div>
                        </div>
                      </td>
                      <td className="py-4 text-white text-right font-mono" data-testid={`text-holding-shares-${index}`}>
                        {holding.shares.toLocaleString()}ì£¼
                      </td>
                      <td className="py-4 text-green-400 font-semibold text-right font-mono" data-testid={`text-holding-avg-price-${index}`}>
                        {formatKoreanCurrency(Number(holding.avgPrice))}
                      </td>
                      <td className="py-4 text-white text-right font-mono" data-testid={`text-holding-current-price-${index}`}>
                        {formatKoreanCurrency(Number(holding.currentPrice))}
                      </td>
                      <td className="py-4 text-white font-medium text-right font-mono" data-testid={`text-holding-market-value-${index}`}>
                        {formatKoreanCurrency(currentValue)}
                      </td>
                      <td className="py-4 text-center" data-testid={`text-holding-profit-loss-${index}`}>
                        {formatProfitLoss(profitAmount, profitPercent)}
                      </td>
                      <td className="py-4">
                        <div className="flex space-x-1 justify-center">
                          <Button 
                            size="sm"
                            className="bg-discord-blue hover:bg-blue-600 text-white px-3 py-1 text-xs disabled:opacity-50"
                            data-testid={`button-buy-more-${index}`}
                            disabled={isTrading === `${holding.symbol}-buy`}
                            onClick={() => executeTrade(holding.symbol, 'buy', holding.currentPrice)}
                          >
                            {isTrading === `${holding.symbol}-buy` ? 'ë§¤ìˆ˜ì¤‘...' : 'ë§¤ìˆ˜'}
                          </Button>
                          <Button 
                            size="sm"
                            className="bg-discord-red hover:bg-red-600 text-white px-3 py-1 text-xs disabled:opacity-50"
                            data-testid={`button-sell-holding-${index}`}
                            disabled={isTrading === `${holding.symbol}-sell` || holding.shares <= 0}
                            onClick={() => executeTrade(holding.symbol, 'sell', holding.currentPrice)}
                          >
                            {isTrading === `${holding.symbol}-sell` ? 'ë§¤ë„ì¤‘...' : 'ë§¤ë„'}
                          </Button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="text-center text-gray-400 py-8">
            ë³´ìœ  ì¤‘ì¸ ì£¼ì‹ì´ ì—†ìŠµë‹ˆë‹¤
          </div>
        )}

        {/* ì§€ì •ê°€ ì£¼ë¬¸ ì„¹ì…˜ - í•­ìƒ í‘œì‹œ */}
        <div className="mt-8 pt-6 border-t border-discord-dark">
          <div className="flex items-center justify-between mb-4">
            <h4 className="text-md font-semibold text-white">ëŒ€ê¸°ì¤‘ì¸ ì§€ì •ê°€ ì£¼ë¬¸</h4>
            {limitOrders && limitOrders.length > 0 && (
              <Badge variant="outline" className="bg-yellow-500/10 text-yellow-400 border-yellow-500/30">
                {limitOrders.length}ê±´
              </Badge>
            )}
          </div>
          
          {isLoadingOrders ? (
            <div className="text-center text-gray-400 py-8">ì§€ì •ê°€ ì£¼ë¬¸ ë¡œë”© ì¤‘...</div>
          ) : ordersError ? (
            <div className="text-center text-red-400 py-8">
              ì§€ì •ê°€ ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤
              <div className="text-xs mt-2">{(ordersError as any)?.message}</div>
            </div>
          ) : !limitOrders || limitOrders.length === 0 ? (
            <div className="text-center text-gray-400 py-8">
              ëŒ€ê¸°ì¤‘ì¸ ì§€ì •ê°€ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤
              <div className="text-xs mt-2 text-gray-500">
                Discordì—ì„œ `/ì£¼ì‹ ì§€ì •ê°€ë§¤ìˆ˜` ë˜ëŠ” `/ì£¼ì‹ ì§€ì •ê°€ë§¤ë„` ëª…ë ¹ì–´ë¡œ ì£¼ë¬¸ì„ ìƒì„±í•˜ì„¸ìš”
              </div>
            </div>
          ) : (
          <div className="mt-8 pt-6 border-t border-discord-dark">
            <div className="flex items-center justify-between mb-4">
              <h4 className="text-md font-semibold text-white">ëŒ€ê¸°ì¤‘ì¸ ì§€ì •ê°€ ì£¼ë¬¸</h4>
              <Badge variant="outline" className="bg-yellow-500/10 text-yellow-400 border-yellow-500/30">
                {limitOrders.length}ê±´
              </Badge>
            </div>
            <div className="space-y-3">
              {limitOrders.map((order: any, index: number) => {
                const executedShares = order.executedShares || 0;
                const remainingShares = order.shares - executedShares;
                const fillPercentage = executedShares > 0 ? (executedShares / order.shares) * 100 : 0;
                const isPartiallyFilled = executedShares > 0 && executedShares < order.shares;
                
                return (
                  <div 
                    key={order.id} 
                    className="bg-discord-dark rounded-lg p-4 border border-discord-light flex items-center justify-between"
                    data-testid={`pending-order-${index}`}
                  >
                    <div className="flex items-center space-x-4 flex-1">
                      <div className={`w-2 h-2 rounded-full ${order.type === 'buy' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                      <div className="flex-1">
                        <div className="flex items-center space-x-2">
                          <span className="text-white font-medium">{order.symbol}</span>
                          <Badge variant="outline" className={order.type === 'buy' ? 'bg-green-500/10 text-green-400 border-green-500/30' : 'bg-red-500/10 text-red-400 border-red-500/30'}>
                            {order.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}
                          </Badge>
                          {isPartiallyFilled && (
                            <Badge variant="outline" className="bg-blue-500/10 text-blue-400 border-blue-500/30">
                              ë¶€ë¶„ì²´ê²° {fillPercentage.toFixed(0)}%
                            </Badge>
                          )}
                        </div>
                        <div className="text-sm text-gray-400 mt-1">
                          {isPartiallyFilled ? (
                            <>
                              <span className="text-blue-400">{executedShares.toLocaleString()}ì£¼ ì²´ê²°</span>
                              <span className="mx-2">â€¢</span>
                              <span className="text-yellow-400">{remainingShares.toLocaleString()}ì£¼ ëŒ€ê¸°</span>
                              <span className="mx-2">@</span>
                              {formatKoreanCurrency(Number(order.targetPrice))}
                            </>
                          ) : (
                            <>
                              {order.shares.toLocaleString()}ì£¼ @ {formatKoreanCurrency(Number(order.targetPrice))}
                              <span className="mx-2">â€¢</span>
                              <span className="text-yellow-400">ì˜ˆì•½ê¸ˆ: {formatKoreanCurrency(Number(order.reservedAmount))}</span>
                            </>
                          )}
                        </div>
                        {isPartiallyFilled && order.executedPrice && (
                          <div className="text-xs text-blue-400 mt-1">
                            í‰ê·  ì²´ê²°ê°€: {formatKoreanCurrency(Number(order.executedPrice))}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-white font-medium">
                        {formatKoreanCurrency(Number(order.totalAmount))}
                      </div>
                      <div className="text-xs text-gray-400 mt-1">
                        {order.expiresAt ? `ë§Œë£Œ: ${format(new Date(order.expiresAt), 'MM/dd HH:mm', { locale: ko })}` : 'ë¬´ê¸°í•œ'}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ) : null}
      </div>
    </div>
  );
}
